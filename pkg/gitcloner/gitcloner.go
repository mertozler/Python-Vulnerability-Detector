package gitcloner

import (
	"github.com/go-git/go-git/v5"
	"github.com/google/uuid"
	"github.com/sirupsen/logrus"
	"os"
)

type Cloner interface {
	CloneRepo(url string) (string, error)
}

type GitClonner struct {
	TargetDirectory string
}

func NewGitClonner() *GitClonner {
	dir, _ := os.Getwd()
	gitCloner := &GitClonner{
		TargetDirectory: dir + "/tmp/src/",
	}
	return gitCloner
}

func (g *GitClonner) CloneRepo(url string) (string, error) {
	scanID := uuid.New()
	logrus.Info("Clonning repository for scan id ", scanID)
	_, err := git.PlainClone(g.TargetDirectory+scanID.String(), false, &git.CloneOptions{
		URL:      url,
		Progress: os.Stdout,
	})
	if err != nil {
		logrus.Errorf("Error while cloning repository for scan id %v", scanID)
		return scanID.String(), err
	}
	return scanID.String(), nil
}
